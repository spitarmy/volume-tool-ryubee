<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ¡ˆä»¶ä¸€è¦§ï½œç«‹ç±³AI Ryuå…µè¡›</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3", "YuGothic", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .box {
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      padding: 16px;
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      font-size: 13px;
    }
    th {
      background: #fafafa;
    }
    tr.clickable:hover {
      background: #f0f8ff;
      cursor: pointer;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      max-width: 400px;
      padding: 4px 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .small-text {
      font-size: 12px;
      color: #666;
    }
    .two-column {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .two-column > .box {
      flex: 1;
      min-width: 320px;
    }
    pre {
      font-size: 11px;
    }
  </style>
</head>
<body>

  <h1>ğŸ“‚ æ¡ˆä»¶ä¸€è¦§ï¼ˆRyuå…µè¡›ï¼‰</h1>
  <p class="small-text">
    ğŸ‘‰ <a href="volume.html">ç”»åƒã‹ã‚‰æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆã™ã‚‹ï¼ˆç«‹ç±³è¨ˆç®—ã¸ï¼‰</a>
  </p>

  <!-- æ¡ˆä»¶ä¸€è¦§ -->
  <div class="box">
    <h3>æ¡ˆä»¶ä¸€è¦§</h3>
    <p class="small-text" id="jobs-status">èª­ã¿è¾¼ã¿ä¸­...</p>
    <table id="jobs-table">
      <thead>
        <tr>
          <th>ä½œæˆæ—¥æ™‚</th>
          <th>ç¾å ´å</th>
          <th>ãŠå®¢æ§˜å</th>
          <th>ä½æ‰€</th>
          <th>ç«‹ç±³</th>
          <th>è¦‹ç©é‡‘é¡</th>
        </tr>
      </thead>
      <tbody>
        <!-- JSã§åŸ‹ã‚ã‚‹ -->
      </tbody>
    </table>
  </div>

  <div class="two-column">
    <!-- æ¡ˆä»¶ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="box" style="flex: 1;">
      <h3>æ¡ˆä»¶æƒ…å ±ï¼ˆç·¨é›†ï¼‰</h3>
      <p id="job-id-label" class="small-text">æ¡ˆä»¶ã‚’ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

      <label>
        ç¾å ´åï¼ˆæ¡ˆä»¶åï¼‰ï¼š
        <input type="text" id="job_name" placeholder="ä¾‹ï¼‰ä¼è¦‹åŒºâ—‹â—‹æ§˜ ä¸ç”¨å“å›å">
      </label>

      <label>
        ãŠå®¢æ§˜åï¼š
        <input type="text" id="customer_name" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ">
      </label>

      <label>
        ä½æ‰€ï¼š
        <input type="text" id="address" placeholder="ä¾‹ï¼‰äº¬éƒ½å¸‚â—‹â—‹åŒºâ€¦">
      </label>

      <label>
        ä½œæ¥­æ—¥ï¼š
        <input type="date" id="work_date">
      </label>

      <label>
        ä½œæ¥­æ™‚é–“å¸¯ï¼š
        <input type="text" id="work_time" placeholder="ä¾‹ï¼‰10:00ã€œ12:00">
      </label>

      <label>
        è¦‹ç©é‡‘é¡ï¼ˆç¨è¾¼ï¼‰ï¼š
        <input type="number" id="price_total" placeholder="ä¾‹ï¼‰45000">
      </label>

      <label>
        ãƒˆãƒ©ãƒƒã‚¯ç¨®åˆ¥ï¼š
        <input type="text" id="truck_type" placeholder="ä¾‹ï¼‰2tãƒ­ãƒ³ã‚°">
      </label>

      <label>
        ä½œæ¥­å“¡äººæ•°ï¼š
        <input type="number" id="workers" placeholder="ä¾‹ï¼‰2">
      </label>

      <label>
        å‚™è€ƒï¼š
        <textarea id="notes" placeholder="ä¾‹ï¼‰2éšãƒ»ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ãªã—ã€è¦é¤Šç”Ÿ ãªã©"></textarea>
      </label>

      <button onclick="saveJob()">æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹</button>
      <button onclick="openWorksheet()" id="worksheet-btn" disabled>ä½œæ¥­æ›¸PDFã‚’é–‹ã</button>
      <p id="job-save-status" class="small-text"></p>
    </div>

    <!-- ç«‹ç±³AIçµæœã®æ¦‚è¦ -->
    <div class="box" style="flex: 1;">
      <h3>ç«‹ç±³AIçµæœï¼ˆæ¦‚è¦ï¼‰</h3>
      <div id="ai-summary">
        <p class="small-text">æ¡ˆä»¶ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«ç«‹ç±³ã‚„å“ç›®ã®æ¦‚è¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <script>
    const JOB_API_BASE = "https://ryubee-api.onrender.com/v1/jobs";
    let currentJobId = null;
    let currentJobData = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—
    window.addEventListener("DOMContentLoaded", () => {
      loadJobs();
    });

    async function loadJobs() {
      const status = document.getElementById("jobs-status");
      const tbody = document.querySelector("#jobs-table tbody");

      status.textContent = "èª­ã¿è¾¼ã¿ä¸­...";

      try {
        const res = await fetch(JOB_API_BASE);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const jobs = await res.json();

        tbody.innerHTML = "";

        if (!Array.isArray(jobs) || jobs.length === 0) {
          status.textContent = "æ¡ˆä»¶ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }

        status.textContent = `æ¡ˆä»¶æ•°ï¼š${jobs.length}`;

        for (const j of jobs) {
          const tr = document.createElement("tr");
          tr.classList.add("clickable");
          tr.addEventListener("click", () => selectJob(j.job_id));

          const created = formatDateTime(j.created_at);
          const volume = j.total_volume_m3 != null ? j.total_volume_m3 + " ã¥" : "-";
          const price = j.price_total != null ? j.price_total.toLocaleString() + " å††" : "-";

          tr.innerHTML = `
            <td>${created}</td>
            <td>${escapeHtml(j.job_name || "")}</td>
            <td>${escapeHtml(j.customer_name || "")}</td>
            <td>${escapeHtml(j.address || "")}</td>
            <td style="text-align:right;">${volume}</td>
            <td style="text-align:right;">${price}</td>
          `;
          tbody.appendChild(tr);
        }

      } catch (e) {
        console.error(e);
        status.textContent = "æ¡ˆä»¶ä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
      }
    }

    // ä¸€ä»¶é¸æŠã—ã¦è©³ç´°å–å¾—
    async function selectJob(jobId) {
      try {
        const res = await fetch(`${JOB_API_BASE}/${jobId}`);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const job = await res.json();

        currentJobId = jobId;
        currentJobData = job;

        document.getElementById("job-id-label").textContent =
          `æ¡ˆä»¶ID: ${jobId}`;

        document.getElementById("job_name").value = job.job_name || "";
        document.getElementById("customer_name").value = job.customer_name || "";
        document.getElementById("address").value = job.address || "";
        document.getElementById("work_date").value = job.work_date || "";
        document.getElementById("work_time").value = job.work_time || "";
        document.getElementById("price_total").value =
          job.price_total != null ? job.price_total : "";
        document.getElementById("truck_type").value = job.truck_type || "";
        document.getElementById("workers").value =
          job.workers != null ? job.workers : "";
        document.getElementById("notes").value = job.notes || "";

        document.getElementById("job-save-status").textContent =
          "â€» ç·¨é›†å¾Œã¯ã€Œæ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";

        // ä½œæ¥­æ›¸ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        document.getElementById("worksheet-btn").disabled = false;

        renderAiSummary(job.ai_result);

      } catch (e) {
        console.error(e);
        alert("æ¡ˆä»¶è©³ç´°ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e);
      }
    }

    // ç«‹ç±³AIçµæœã®æ¦‚è¦ã‚’è¡¨ç¤º
    function renderAiSummary(ai) {
      const container = document.getElementById("ai-summary");
      if (!ai) {
        container.innerHTML = "<p class=\"small-text\">AIçµæœãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        return;
      }

      let html = "";

      html += `<p><strong>ç«‹ç±³ï¼š</strong> ${ai.total_volume_m3 ?? "-"} ã¥</p>`;

      if (Array.isArray(ai.items) && ai.items.length > 0) {
        html += `<p><strong>å“ç›®ä¸€è¦§ï¼š</strong></p>`;
        html += `<table>`;
        html += `<tr>
          <th>å“ç›®</th>
          <th>ã‚µãƒ–ã‚¿ã‚¤ãƒ—</th>
          <th>æ•°é‡</th>
          <th>ç«‹ç±³å°è¨ˆ</th>
        </tr>`;
        for (const item of ai.items) {
          html += `<tr>
            <td>${item.category ?? ""}</td>
            <td>${item.subtype ?? ""}</td>
            <td style="text-align:right;">${item.quantity ?? ""}</td>
            <td style="text-align:right;">${item.volume_total_m3 ?? ""}</td>
          </tr>`;
        }
        html += `</table>`;
      }

      html += `<details style="margin-top:12px;">
        <summary class="small-text">RAW JSONï¼ˆAIçµæœãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</summary>
        <pre>${escapeHtml(JSON.stringify(ai, null, 2))}</pre>
      </details>`;

      container.innerHTML = html;
    }

    // æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜
    async function saveJob() {
      if (!currentJobId) {
        alert("ã¾ãšä¸€è¦§ã‹ã‚‰æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const payload = {};
      const jobName = document.getElementById("job_name").value.trim();
      const customerName = document.getElementById("customer_name").value.trim();
      const address = document.getElementById("address").value.trim();
      const workDate = document.getElementById("work_date").value.trim();
      const workTime = document.getElementById("work_time").value.trim();
      const priceTotal = document.getElementById("price_total").value.trim();
      const truckType = document.getElementById("truck_type").value.trim();
      const workers = document.getElementById("workers").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (jobName) payload.job_name = jobName;
      if (customerName) payload.customer_name = customerName;
      if (address) payload.address = address;
      if (workDate) payload.work_date = workDate;
      if (workTime) payload.work_time = workTime;
      if (priceTotal) payload.price_total = Number(priceTotal);
      if (truckType) payload.truck_type = truckType;
      if (workers) payload.workers = Number(workers);
      if (notes) payload.notes = notes;

      const status = document.getElementById("job-save-status");
      status.textContent = "ä¿å­˜ä¸­...";

      try {
        const res = await fetch(`${JOB_API_BASE}/${currentJobId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        status.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚";

        if (data.job_name) {
          document.getElementById("job-id-label").textContent =
            `æ¡ˆä»¶ID: ${currentJobId} ï¼ ç¾å ´å: ${data.job_name}`;
        }

        loadJobs();

      } catch (e) {
        console.error(e);
        status.textContent = "ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
      }
    }

    // ä½œæ¥­æ›¸PDFã‚’é–‹ã
    function openWorksheet() {
      if (!currentJobId) {
        alert("ã¾ãšä¸€è¦§ã‹ã‚‰æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const url = `${JOB_API_BASE}/${currentJobId}/worksheet`;
      window.open(url, "_blank");
    }

    // æ—¥æ™‚æ–‡å­—åˆ—ã‚’è¦‹ã‚„ã™ãã™ã‚‹ï¼ˆè¶…ç°¡æ˜“ï¼‰
    function formatDateTime(str) {
      if (!str) return "";
      return str.replace("T", " ").slice(0, 16);
    }

    // XSSé˜²æ­¢ç”¨
    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
  </script>

</body>
</html>
