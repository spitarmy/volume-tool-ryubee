<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç«‹ç±³AIï½œRyuå…µè¡›</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
    #result { white-space: pre-wrap; background: #f7f7f7; padding: 20px; }
  </style>
</head>
<body>

  <h1>ğŸ“¦ ç«‹ç±³AIï¼ˆRyuå…µè¡›ï¼‰</h1>

  <div class="box">
    <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
    <input type="file" id="images" multiple accept="image/*">
    <br><br>
    <button onclick="sendImages()">ç«‹ç±³ã‚’è¨ˆç®—ã™ã‚‹</button>
  </div>

  <div class="box">
    <h3>çµæœ</h3>
    <div id="result">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <script>
  async function sendImages() {
    const files = document.getElementById("images").files;
    if (files.length === 0) {
      alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const formData = new FormData();
    for (const f of files) formData.append("images", f);

    const API_URL = "https://ryubee-api.onrender.com/v1/volume-estimate";

    document.getElementById("result").innerHTML = "è¨ˆç®—ä¸­...";

    try {
      const res = await fetch(API_URL, { method: "POST", body: formData });
      const data = await res.json();
      renderResult(data);
    } catch (e) {
      console.error(e);
      document.getElementById("result").innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
    }
  }

  function renderResult(data) {
    let html = "";

    // ç«‹ç±³
    html += `<h2>ç«‹ç±³</h2>`;
    html += `<p style="font-size: 1.8rem; font-weight: bold; margin-top: 0;">${data.total_volume_m3 ?? "-"} ã¥</p>`;

    // å“ç›®ä¸€è¦§
    if (Array.isArray(data.items) && data.items.length > 0) {
      html += `<h2>å“ç›®ä¸€è¦§</h2>`;
      html += `<table border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 100%; max-width: 800px;">`;
      html += `<tr>
        <th>å“ç›®</th>
        <th>ã‚µãƒ–ã‚¿ã‚¤ãƒ—</th>
        <th>ã‚µã‚¤ã‚º</th>
        <th>æ•°é‡</th>
        <th>ç«‹ç±³/å€‹</th>
        <th>ç«‹ç±³å°è¨ˆ</th>
        <th>åŒºåˆ†</th>
      </tr>`;

      for (const item of data.items) {
        const flags = (item.flags || []).join(" / ");
        html += `<tr>
          <td>${item.category ?? ""}</td>
          <td>${item.subtype ?? ""}</td>
          <td>${item.size_class ?? ""}</td>
          <td style="text-align:right;">${item.quantity ?? ""}</td>
          <td style="text-align:right;">${item.volume_per_item_m3 ?? ""}</td>
          <td style="text-align:right;">${item.volume_total_m3 ?? ""}</td>
          <td>${flags}</td>
        </tr>`;
      }
      html += `</table>`;
    }

    // ç‰¹å‡¦åˆ†ã¾ã¨ã‚
    if (data.special_disposal) {
      html += `<h2>ç‰¹å‡¦åˆ†ãƒ»ãƒªã‚µã‚¤ã‚¯ãƒ«</h2><ul>`;
      if (Array.isArray(data.special_disposal.recycle_items) && data.special_disposal.recycle_items.length) {
        html += `<li>å®¶é›»ãƒªã‚µã‚¤ã‚¯ãƒ«ï¼š${data.special_disposal.recycle_items.join("ã€")}</li>`;
      }
      if (Array.isArray(data.special_disposal.hard_disposal_items) && data.special_disposal.hard_disposal_items.length) {
        html += `<li>ç‰¹å‡¦åˆ†å“ï¼š${data.special_disposal.hard_disposal_items.join("ã€")}</li>`;
      }
      if (Array.isArray(data.special_disposal.dangerous_items) && data.special_disposal.dangerous_items.length) {
        html += `<li>å±é™ºç‰©ï¼š${data.special_disposal.dangerous_items.join("ã€")}</li>`;
      }
      html += `</ul>`;
    }

    // æ³¨æ„äº‹é …
    if (Array.isArray(data.warnings) && data.warnings.length > 0) {
      html += `<h2>æ³¨æ„äº‹é …</h2><ul>`;
      for (const w of data.warnings) {
        html += `<li>${w}</li>`;
      }
      html += `</ul>`;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨RAW JSON
    html += `<details style="margin-top:20px;">
      <summary>RAW JSONï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</summary>
      <pre style="background:#f5f5f5; padding:10px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
    </details>`;

    document.getElementById("result").innerHTML = html;
  }

  // XSSé˜²æ­¢ç”¨ï¼špreå†…ã®JSONã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
</script>


</body>
</html>
