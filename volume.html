<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç«‹ç±³AIï½œRyuå…µè¡›</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
    #result { white-space: pre-wrap; background: #f7f7f7; padding: 20px; }
  </style>
</head>
<body>

  <h1>ğŸ“¦ ç«‹ç±³AIï¼ˆRyuå…µè¡›ï¼‰</h1>

  <div class="box">
    <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
    <input type="file" id="images" multiple accept="image/*">
    <br><br>
    <button onclick="sendImages()">ç«‹ç±³ã‚’è¨ˆç®—ã™ã‚‹</button>
  </div>

  <div class="box">
    <h3>çµæœ</h3>
    <div id="result">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <script>
  // ===== è¨­å®šå€¤ =====
  const MAX_FILES = 20;        // ç”»åƒã®æœ€å¤§æšæ•°
  const MAX_WIDTH = 1600;      // ãƒªã‚µã‚¤ã‚ºå¾Œã®æœ€å¤§å¹…
  const MAX_HEIGHT = 1600;     // ãƒªã‚µã‚¤ã‚ºå¾Œã®æœ€å¤§é«˜ã•
  const JPEG_QUALITY = 0.7;    // JPEGåœ§ç¸®å“è³ªï¼ˆ0ã€œ1ï¼‰
  const API_URL = "https://ryubee-api.onrender.com/v1/volume-estimate";

  // ç”»åƒé€ä¿¡ãƒ¡ã‚¤ãƒ³å‡¦ç†
  async function sendImages() {
    const input = document.getElementById("images");
    const files = input.files;

    if (files.length === 0) {
      alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    // â˜… æšæ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (files.length > MAX_FILES) {
      alert(`ç”»åƒã¯æœ€å¤§ ${MAX_FILES} æšã¾ã§ã«ã—ã¦ãã ã•ã„ã€‚\nç¾åœ¨: ${files.length} æš`);
      return;
    }

    const formData = new FormData();

    // â˜… ã“ã“ã§1æšãšã¤åœ§ç¸®ã—ã¦ã‹ã‚‰ FormData ã«å…¥ã‚Œã‚‹
    for (const file of files) {
      try {
        const compressed = await compressImage(file, MAX_WIDTH, MAX_HEIGHT, JPEG_QUALITY);
        formData.append("images", compressed, compressed.name);
        console.log(`compressed: ${file.name} -> ${compressed.size} bytes`);
      } catch (err) {
        console.error(err);
        alert("ç”»åƒã®åœ§ç¸®ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
        return;
      }
    }

    document.getElementById("result").innerHTML = "è¨ˆç®—ä¸­...";

    try {
      const res = await fetch(API_URL, { method: "POST", body: formData });
      const data = await res.json();
      renderResult(data);
    } catch (e) {
      console.error(e);
      document.getElementById("result").innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
    }
  }

  // â˜… ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼‹JPEGåœ§ç¸®ã™ã‚‹é–¢æ•°
  function compressImage(file, maxWidth, maxHeight, quality) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;

          // ç¸®å°å€ç‡ï¼ˆ1ã‚ˆã‚Šå°ã•ãã™ã‚‹ã€1ã‚ˆã‚Šå¤§ããã¯ã—ãªã„ï¼ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„ï¼‰
          const scale = Math.min(maxWidth / width, maxHeight / height, 1);

          const canvas = document.createElement("canvas");
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          canvas.toBlob(
            (blob) => {
              if (!blob) {
                reject(new Error("ç”»åƒåœ§ç¸®ã«å¤±æ•—ã—ã¾ã—ãŸ"));
                return;
              }
              // å…ƒã®æ‹¡å¼µå­ã«é–¢ã‚ã‚‰ãš jpeg ã«çµ±ä¸€
              const newName =
                file.name.replace(/\.(png|jpg|jpeg|webp|heic)$/i, "") + ".jpg";
              const compressedFile = new File([blob], newName, {
                type: "image/jpeg",
              });
              resolve(compressedFile);
            },
            "image/jpeg",
            quality
          );
        };
        img.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
        img.src = e.target.result;
      };

      reader.onerror = () => reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      reader.readAsDataURL(file);
    });
  }

  // ===== ä»¥ä¸‹ã¯å‰ã¨åŒã˜ã€Œçµæœè¡¨ç¤ºã€ã¾ã‚ã‚Š =====

  function renderResult(data) {
    let html = "";

    // ç«‹ç±³
    html += `<h2>ç«‹ç±³</h2>`;
    html += `<p style="font-size: 1.8rem; font-weight: bold; margin-top: 0;">${data.total_volume_m3 ?? "-"} ã¥</p>`;

    // å“ç›®ä¸€è¦§
    if (Array.isArray(data.items) && data.items.length > 0) {
      html += `<h2>å“ç›®ä¸€è¦§</h2>`;
      html += `<table border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 100%; max-width: 800px;">`;
      html += `<tr>
        <th>å“ç›®</th>
        <th>ã‚µãƒ–ã‚¿ã‚¤ãƒ—</th>
        <th>ã‚µã‚¤ã‚º</th>
        <th>æ•°é‡</th>
        <th>ç«‹ç±³/å€‹</th>
        <th>ç«‹ç±³å°è¨ˆ</th>
        <th>åŒºåˆ†</th>
      </tr>`;

      for (const item of data.items) {
        const flags = (item.flags || []).join(" / ");
        html += `<tr>
          <td>${item.category ?? ""}</td>
          <td>${item.subtype ?? ""}</td>
          <td>${item.size_class ?? ""}</td>
          <td style="text-align:right;">${item.quantity ?? ""}</td>
          <td style="text-align:right;">${item.volume_per_item_m3 ?? ""}</td>
          <td style="text-align:right;">${item.volume_total_m3 ?? ""}</td>
          <td>${flags}</td>
        </tr>`;
      }
      html += `</table>`;
    }

    // ç‰¹å‡¦åˆ†ã¾ã¨ã‚
    if (data.special_disposal) {
      html += `<h2>ç‰¹å‡¦åˆ†ãƒ»ãƒªã‚µã‚¤ã‚¯ãƒ«</h2><ul>`;
      if (Array.isArray(data.special_disposal.recycle_items) && data.special_disposal.recycle_items.length) {
        html += `<li>å®¶é›»ãƒªã‚µã‚¤ã‚¯ãƒ«ï¼š${data.special_disposal.recycle_items.join("ã€")}</li>`;
      }
      if (Array.isArray(data.special_disposal.hard_disposal_items) && data.special_disposal.hard_disposal_items.length) {
        html += `<li>ç‰¹å‡¦åˆ†å“ï¼š${data.special_disposal.hard_disposal_items.join("ã€")}</li>`;
      }
      if (Array.isArray(data.special_disposal.dangerous_items) && data.special_disposal.dangerous_items.length) {
        html += `<li>å±é™ºç‰©ï¼š${data.special_disposal.dangerous_items.join("ã€")}</li>`;
      }
      html += `</ul>`;
    }

    // æ³¨æ„äº‹é …
    if (Array.isArray(data.warnings) && data.warnings.length > 0) {
      html += `<h2>æ³¨æ„äº‹é …</h2><ul>`;
      for (const w of data.warnings) {
        html += `<li>${w}</li>`;
      }
      html += `</ul>`;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨RAW JSON
    html += `<details style="margin-top:20px;">
      <summary>RAW JSONï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</summary>
      <pre style="background:#f5f5f5; padding:10px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
    </details>`;

    document.getElementById("result").innerHTML = html;
  }

  // XSSé˜²æ­¢ç”¨ï¼špreå†…ã®JSONã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
</script>



</body>
</html>
