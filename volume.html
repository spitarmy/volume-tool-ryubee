<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç«‹ç±³AIï½œRyuå…µè¡›</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3", "YuGothic", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .box {
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
    }
    #result {
      white-space: normal;
    }
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      font-size: 14px;
    }
    th {
      background: #fafafa;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea {
      width: 100%;
      max-width: 400px;
      padding: 4px 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .small-text {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>ğŸ“¦ ç«‹ç±³AIï¼ˆRyuå…µè¡›ï¼‰</h1>

  <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div class="box">
    <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
    <input type="file" id="images" multiple accept="image/*">
    <p class="small-text">â€» æœ€å¤§20æšã¾ã§ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«è‡ªå‹•ã§åœ§ç¸®ã•ã‚Œã¾ã™ã€‚</p>
    <br>
    <button onclick="sendImages()">ç«‹ç±³ã‚’è¨ˆç®—ã™ã‚‹</button>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="box">
    <h3>çµæœ</h3>
    <div id="result">ã¾ã è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <!-- æ¡ˆä»¶æƒ…å ± ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="box" id="job-box" style="display:none;">
    <h3>æ¡ˆä»¶æƒ…å ±ï¼ˆç·¨é›†å¯ï¼‰</h3>
    <p id="job-id-label" class="small-text">æ¡ˆä»¶ID: -</p>

    <label>
      ç¾å ´åï¼ˆæ¡ˆä»¶åï¼‰ï¼š
      <input type="text" id="job_name" placeholder="ä¾‹ï¼‰ä¼è¦‹åŒºâ—‹â—‹æ§˜ ä¸ç”¨å“å›å">
    </label>

    <label>
      ãŠå®¢æ§˜åï¼š
      <input type="text" id="customer_name" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ">
    </label>

    <label>
      ä½æ‰€ï¼š
      <input type="text" id="address" placeholder="ä¾‹ï¼‰äº¬éƒ½å¸‚â—‹â—‹åŒºâ€¦">
    </label>

    <label>
      ä½œæ¥­æ—¥ï¼š
      <input type="date" id="work_date">
    </label>

    <label>
      ä½œæ¥­æ™‚é–“å¸¯ï¼š
      <input type="text" id="work_time" placeholder="ä¾‹ï¼‰10:00ã€œ12:00">
    </label>

    <label>
      è¦‹ç©é‡‘é¡ï¼ˆç¨è¾¼ï¼‰ï¼š
      <input type="number" id="price_total" placeholder="ä¾‹ï¼‰45000">
    </label>

    <label>
      ãƒˆãƒ©ãƒƒã‚¯ç¨®åˆ¥ï¼š
      <input type="text" id="truck_type" placeholder="ä¾‹ï¼‰2tãƒ­ãƒ³ã‚°">
    </label>

    <label>
      ä½œæ¥­å“¡äººæ•°ï¼š
      <input type="number" id="workers" placeholder="ä¾‹ï¼‰2">
    </label>

    <label>
      å‚™è€ƒï¼š
      <textarea id="notes" placeholder="ä¾‹ï¼‰2éšãƒ»ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ãªã—ã€è¦é¤Šç”Ÿ ãªã©"></textarea>
    </label>

    <button onclick="saveJob()">æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹</button>
    <p id="job-save-status" class="small-text"></p>
  </div>

  <script>
    // ===== è¨­å®šå€¤ =====
    const MAX_FILES = 20;        // ç”»åƒã®æœ€å¤§æšæ•°
    const MAX_WIDTH = 1600;      // ãƒªã‚µã‚¤ã‚ºå¾Œã®æœ€å¤§å¹…
    const MAX_HEIGHT = 1600;     // ãƒªã‚µã‚¤ã‚ºå¾Œã®æœ€å¤§é«˜ã•
    const JPEG_QUALITY = 0.7;    // JPEGåœ§ç¸®å“è³ªï¼ˆ0ã€œ1ï¼‰

    const API_URL = "https://ryubee-api.onrender.com/v1/volume-estimate";
    const JOB_API_BASE = "https://ryubee-api.onrender.com/v1/jobs";

    let currentJobId = null;     // ç›´è¿‘ã§è¨ˆç®—ã—ãŸæ¡ˆä»¶ã®ID

    // ç”»åƒé€ä¿¡ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function sendImages() {
      const input = document.getElementById("images");
      const files = input.files;

      if (files.length === 0) {
        alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      // æšæ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (files.length > MAX_FILES) {
        alert(`ç”»åƒã¯æœ€å¤§ ${MAX_FILES} æšã¾ã§ã«ã—ã¦ãã ã•ã„ã€‚\nç¾åœ¨: ${files.length} æš`);
        return;
      }

      const formData = new FormData();

      // 1æšãšã¤åœ§ç¸®ã—ã¦ã‹ã‚‰ FormData ã«å…¥ã‚Œã‚‹
      for (const file of files) {
        try {
          const compressed = await compressImage(file, MAX_WIDTH, MAX_HEIGHT, JPEG_QUALITY);
          formData.append("images", compressed, compressed.name);
          console.log(`compressed: ${file.name} -> ${compressed.size} bytes`);
        } catch (err) {
          console.error(err);
          alert("ç”»åƒã®åœ§ç¸®ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
          return;
        }
      }

      document.getElementById("result").innerHTML = "è¨ˆç®—ä¸­...";

      try {
        const res = await fetch(API_URL, { method: "POST", body: formData });
        const data = await res.json();
        renderResult(data);
        setupJobBox(data);
      } catch (e) {
        console.error(e);
        document.getElementById("result").innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
      }
    }

    // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼‹JPEGåœ§ç¸®ã™ã‚‹é–¢æ•°
    function compressImage(file, maxWidth, maxHeight, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // ç¸®å°å€ç‡ï¼ˆ1ã‚ˆã‚Šå°ã•ãã™ã‚‹ã€1ã‚ˆã‚Šå¤§ããã¯ã—ãªã„ï¼ã‚¢ãƒƒãƒ—ã‚¹ã‚±ãƒ¼ãƒ«ã—ãªã„ï¼‰
            const scale = Math.min(maxWidth / width, maxHeight / height, 1);

            const canvas = document.createElement("canvas");
            canvas.width = Math.round(width * scale);
            canvas.height = Math.round(height * scale);

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(
              (blob) => {
                if (!blob) {
                  reject(new Error("ç”»åƒåœ§ç¸®ã«å¤±æ•—ã—ã¾ã—ãŸ"));
                  return;
                }
                // å…ƒã®æ‹¡å¼µå­ã«é–¢ã‚ã‚‰ãš jpeg ã«çµ±ä¸€
                const newName =
                  file.name.replace(/\.(png|jpg|jpeg|webp|heic)$/i, "") + ".jpg";
                const compressedFile = new File([blob], newName, {
                  type: "image/jpeg",
                });
                resolve(compressedFile);
              },
              "image/jpeg",
              quality
            );
          };
          img.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
          img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
        reader.readAsDataURL(file);
      });
    }

    // ç«‹ç±³çµæœã®è¡¨ç¤º
    function renderResult(data) {
      let html = "";

      // ç«‹ç±³
      html += `<h2>ç«‹ç±³</h2>`;
      html += `<p style="font-size: 1.8rem; font-weight: bold; margin-top: 0;">${data.total_volume_m3 ?? "-"} ã¥</p>`;

      // å“ç›®ä¸€è¦§
      if (Array.isArray(data.items) && data.items.length > 0) {
        html += `<h2>å“ç›®ä¸€è¦§</h2>`;
        html += `<table style="width: 100%; max-width: 800px;">`;
        html += `<tr>
          <th>å“ç›®</th>
          <th>ã‚µãƒ–ã‚¿ã‚¤ãƒ—</th>
          <th>ã‚µã‚¤ã‚º</th>
          <th>æ•°é‡</th>
          <th>ç«‹ç±³/å€‹</th>
          <th>ç«‹ç±³å°è¨ˆ</th>
          <th>åŒºåˆ†</th>
        </tr>`;

        for (const item of data.items) {
          const flags = (item.flags || []).join(" / ");
          html += `<tr>
            <td>${item.category ?? ""}</td>
            <td>${item.subtype ?? ""}</td>
            <td>${item.size_class ?? ""}</td>
            <td style="text-align:right;">${item.quantity ?? ""}</td>
            <td style="text-align:right;">${item.volume_per_item_m3 ?? ""}</td>
            <td style="text-align:right;">${item.volume_total_m3 ?? ""}</td>
            <td>${flags}</td>
          </tr>`;
        }
        html += `</table>`;
      }

      // ç‰¹å‡¦åˆ†ã¾ã¨ã‚
      if (data.special_disposal) {
        html += `<h2>ç‰¹å‡¦åˆ†ãƒ»ãƒªã‚µã‚¤ã‚¯ãƒ«</h2><ul>`;
        if (Array.isArray(data.special_disposal.recycle_items) && data.special_disposal.recycle_items.length) {
          html += `<li>å®¶é›»ãƒªã‚µã‚¤ã‚¯ãƒ«ï¼š${data.special_disposal.recycle_items.join("ã€")}</li>`;
        }
        if (Array.isArray(data.special_disposal.hard_disposal_items) && data.special_disposal.hard_disposal_items.length) {
          html += `<li>ç‰¹å‡¦åˆ†å“ï¼š${data.special_disposal.hard_disposal_items.join("ã€")}</li>`;
        }
        if (Array.isArray(data.special_disposal.dangerous_items) && data.special_disposal.dangerous_items.length) {
          html += `<li>å±é™ºç‰©ï¼š${data.special_disposal.dangerous_items.join("ã€")}</li>`;
        }
        html += `</ul>`;
      }

      // æ³¨æ„äº‹é …
      if (Array.isArray(data.warnings) && data.warnings.length > 0) {
        html += `<h2>æ³¨æ„äº‹é …</h2><ul>`;
        for (const w of data.warnings) {
          html += `<li>${w}</li>`;
        }
        html += `</ul>`;
      }

      // ãƒ‡ãƒãƒƒã‚°ç”¨RAW JSON
      html += `<details style="margin-top:20px;">
        <summary>RAW JSONï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</summary>
        <pre style="background:#f5f5f5; padding:10px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
      </details>`;

      document.getElementById("result").innerHTML = html;
    }

    // æ¡ˆä»¶ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupJobBox(data) {
      currentJobId = data.job_id || null;

      const jobBox = document.getElementById("job-box");
      const jobIdLabel = document.getElementById("job-id-label");
      const status = document.getElementById("job-save-status");

      if (!currentJobId) {
        jobBox.style.display = "none";
        status.textContent = "";
        return;
      }

      jobBox.style.display = "block";
      jobIdLabel.textContent = `æ¡ˆä»¶ID: ${currentJobId}`;
      status.textContent = "â€» ã“ã®æ¡ˆä»¶ã®æƒ…å ±ã‚’ç·¨é›†ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚";

      // æ–°è¦ä½œæˆç›´å¾Œãªã®ã§ãƒ•ã‚©ãƒ¼ãƒ ã¯ç©ºã§OKï¼ˆå¿…è¦ãªã‚‰ã“ã“ã§åˆæœŸå€¤ã‚’å…¥ã‚Œã‚‹ï¼‰
      document.getElementById("job_name").value = "";
      document.getElementById("customer_name").value = "";
      document.getElementById("address").value = "";
      document.getElementById("work_date").value = "";
      document.getElementById("work_time").value = "";
      document.getElementById("price_total").value = "";
      document.getElementById("truck_type").value = "";
      document.getElementById("workers").value = "";
      document.getElementById("notes").value = "";
    }

    // æ¡ˆä»¶æƒ…å ±ã‚’ä¿å­˜ï¼ˆPOST /v1/jobs/{job_id}ï¼‰
    async function saveJob() {
      if (!currentJobId) {
        alert("æ¡ˆä»¶IDãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ç«‹ç±³è¨ˆç®—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚");
        return;
      }

      const payload = {};
      const jobName = document.getElementById("job_name").value.trim();
      const customerName = document.getElementById("customer_name").value.trim();
      const address = document.getElementById("address").value.trim();
      const workDate = document.getElementById("work_date").value.trim();
      const workTime = document.getElementById("work_time").value.trim();
      const priceTotal = document.getElementById("price_total").value.trim();
      const truckType = document.getElementById("truck_type").value.trim();
      const workers = document.getElementById("workers").value.trim();
      const notes = document.getElementById("notes").value.trim();

      if (jobName) payload.job_name = jobName;
      if (customerName) payload.customer_name = customerName;
      if (address) payload.address = address;
      if (workDate) payload.work_date = workDate;
      if (workTime) payload.work_time = workTime;
      if (priceTotal) payload.price_total = Number(priceTotal);
      if (truckType) payload.truck_type = truckType;
      if (workers) payload.workers = Number(workers);
      if (notes) payload.notes = notes;

      const status = document.getElementById("job-save-status");
      status.textContent = "ä¿å­˜ä¸­...";

      try {
        const res = await fetch(`${JOB_API_BASE}/${currentJobId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        status.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚";

        if (data.job_name) {
          document.getElementById("job-id-label").textContent =
            `æ¡ˆä»¶ID: ${currentJobId} ï¼ ç¾å ´å: ${data.job_name}`;
        }
      } catch (e) {
        console.error(e);
        status.textContent = "ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" + e;
      }
    }

    // XSSé˜²æ­¢ç”¨ï¼špreå†…ã®JSONã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
  </script>

</body>
</html>
